

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialConnectProfile</title>
    <link rel="stylesheet" href="profilecss.css">
    <style>
        /* Your existing CSS styles */
        .menu {
            
            display: inline-block;
            cursor: pointer;
            margin-left: 800px;
        }
        .menu-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }
        .menu-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .menu-content a:hover {
            background-color: #f1f1f1;
        }
        .menu:hover .menu-content {
            display: block;
        }
        .video-post {
            position: relative;
            padding: 15px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        .post-options {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .three-dots {
            font-size: 24px;
            cursor: pointer;
        }
        .bookmark-button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            margin-top: 10px;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }
        .bookmark-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>SocialConnect</h1>
            <ul>
                <li><a href="feed.html">Feed</a></li>
                <li><a href="video.html">Videos</a></li>
                
                <li><a href="bookmarks.html">Bookmarks</a></li>
                <li><a href="job.html">Jobs</a></li>
                <li><a href="events.html">Events</a></li>
                <li><a href="groups.html">Groups</a></li>
                <li><a href="courses.html">Courses</a></li>
            </ul>
            <div class="profile-section">
                <div class="profile">
                    <img id="sidebarProfileImage" src="images/profile.png" alt="Profile Picture">
                    <a href="profile.html" class="profilename"><span id="profileName">Profile Name</span></a>
                </div>
            </div>
        </div>
        <div class="main-content">
           
                <div class="profile-info">
                    <!-- Profile Picture -->
                    <img id="profileImage" src="images/profile.png" alt="Profile Picture" class="profileimage" onclick="uploadProfileImage()">
                    <!-- Hidden file input for profile picture -->
                    <input type="file" id="profileImageInput" style="display: none" accept="image/*">
                    <div class="profile-details">
                        
                        <div class="otherProfileDetails">
                            <h2 id="profileNameHeader">Profile name</h2>
                            <p>Email: <span id="profileEmail"></span></p><br><br>
                            <button type="submit" id="logout">Logout</button><br><br><br>
                           
                            <!-- Add more profile details as needed -->
                        </div>
                        
                    </div>
                    
                </div>
            
            <div class="post-input">
                <div id="profile-picture-container">
                    <img id="profile-picture" src="images/profile.png" alt="Profile Picture" oninput="uploadProfileImage()" style="cursor:pointer;">
                    <!-- Hidden file input for profile picture -->
                    <input type="file" id="profile-picture-input" style="display:none" ;>
                </div>
                <input type="text" id="searchInput" placeholder="Search..." oninput="searchPosts(this.value)">
                <a href="postupload.html"><button type="submit">Photo/Video</button></a>
            </div>

            <div class="profile-feed" id="profile-feed">
                <!-- Posts will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('user'));
            if (user && user.username) {
                document.getElementById('profileName').textContent = user.username;
                document.getElementById('profileNameHeader').textContent = user.username;
                document.getElementById('profileEmail').textContent = user.email;
            }
            const searchInput = document.getElementById('searchInput');
            const profileFeed = document.getElementById('profile-feed');
            let allPosts = []; // Array to store all posts initially
            searchInput.addEventListener('input', (event) => {
        const query = event.target.value.trim().toLowerCase(); // Trim whitespace and convert to lowercase

        const filteredPosts = allPosts.filter(post =>
            post.title.toLowerCase().includes(query)
        );
        renderPosts(filteredPosts);
    });
            async function fetchUserPosts() {
                try {
                    const token = localStorage.getItem('token');
                    const userId = JSON.parse(localStorage.getItem('user')).userId;
                    const response = await fetch('/api/Profile', {
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (!response.ok) {
                        throw new Error('Failed to fetch user posts');
                    }
                    const posts = await response.json();
                    allPosts = posts; // Store all posts in the variable
                    renderPosts(posts);
                } catch (error) {
                    console.error('Error fetching user posts:', error);
                }
            }

            /*function searchPosts(query) {
                const filteredPosts = allPosts.filter(post =>
                    post.title.toLowerCase().includes(query.toLowerCase())
                );
                renderPosts(filteredPosts);
            }
*/
            function renderPosts(posts) {
                const profileFeed = document.getElementById('profile-feed');
                profileFeed.innerHTML = ''; // Clear the profile feed
                
                if (posts.length === 0) {
                    profileFeed.innerHTML = '<p>No posts found</p>';
                    return;
                }

                // Update post count
                //document.getElementById('postCount').textContent = `Posts: ${posts.length}`;

                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.classList.add('profile-post');

                    // Display media (image or video)
                    let mediaElement;
                    if (post.filename.match(/\.(jpeg|jpg|gif|png)$/)) {
                        // Create image element for image files
                        mediaElement = document.createElement('img');
                        mediaElement.src = `/uploads/${post.filename}`;
                        mediaElement.alt = 'Post Image';
                    } else if (post.filename.match(/\.(mp4|webm|ogg)$/)) {
                        // Create video element for video files
                        mediaElement = document.createElement('video');
                        mediaElement.src = `/uploads/${post.filename}`;
                        mediaElement.controls = true;
                    }

                    const title = document.createElement('h5');
                    title.textContent = post.title;

                    const description = document.createElement('p');
                    description.textContent = post.description;

                    const uploadDate = document.createElement('p');
                    uploadDate.textContent = `Uploaded on: ${new Date(post.uploadDate).toLocaleString()}`;

                    const likeButton = document.createElement('button');
                    likeButton.textContent = `Like (${post.likes || 0})`;
                    likeButton.addEventListener('click', async () => {
                        try {
                            const likeResponse = await fetch(`/api/profile/${post._id}/like`, { method: 'POST' });
                            if (!likeResponse.ok) {
                                throw new Error('Failed to like post');
                            }
                            const likeData = await likeResponse.json();
                            likeButton.textContent = `Like (${likeData.likes})`;
                        } catch (error) {
                            console.error('Error liking post:', error);
                        }
                    });

 const commentButton = document.createElement('button');
            commentButton.textContent = 'Comment';
            commentButton.addEventListener('click', () => {
                toggleCommentSection(post._id);
            });
                  
            
            const bookmarkButton = document.createElement('button');
                    bookmarkButton.textContent = 'Bookmark';
                    bookmarkButton.addEventListener('click', async () => {
                        try {
                            const postId = post._id;
                            const token = localStorage.getItem('token');
                            const userId = JSON.parse(localStorage.getItem('user')).userId; // Extract userId from localStorage
                            const itemModel = 'Profile'; // Assuming 'Profile' as the item model
                            const createdAt = new Date().toISOString(); // Current timestamp

                            if (!token) {
                                throw new Error('User not authenticated');
                            }

                            const response = await fetch(`/api/profile/${postId}/add`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({ userId, createdAt })
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Failed to add post to bookmarks');
                            }

                            alert('Post added to bookmarks successfully!');
                        } catch (error) {
                            console.error('Error adding post to bookmarks:', error);
                            alert(`Error: ${error.message}`);
                        }
                    });
const shareButton = document.createElement('button');
shareButton.textContent = 'Share';
shareButton.addEventListener('click', async () => {
    try {
        const postId = post._id;
        const token = localStorage.getItem('token');
        const userId = JSON.parse(localStorage.getItem('user')).userId;
        const itemModel = 'Profile';
        const sharedAt = new Date().toISOString();

        if (!token) {
            throw new Error('User not authenticated');
        }

        const response = await fetch(`/api/profile/${postId}/share`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ userId, sharedAt, itemModel })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to share profile');
        }

        alert('Profile shared successfully!');
    } catch (error) {
        console.error('Error sharing profile:', error);
        alert(`Error: ${error.message}`);
    }
});




                    const menu = document.createElement('div');
                    menu.classList.add('menu');
                    const menuIcon = document.createElement('span');
                    menuIcon.textContent = '⋮';
                    menuIcon.classList.add('three-dots');
                    menuIcon.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevents closing the menu on click
                const menuContent = menu.querySelector('.menu-content');
                menuContent.style.display = menuContent.style.display === 'block' ? 'none' : 'block';
            });
                    menu.appendChild(menuIcon);

                    const menuContent = document.createElement('div');
                    menuContent.classList.add('menu-content');

                    const updateOption = document.createElement('a');
                    updateOption.href = 'postupdate.html?postId=${post._id}';
                    updateOption.textContent = 'Update';
                    updateOption.addEventListener('click', () => {
                        event.preventDefault();
                        localStorage.setItem('postToUpdate', JSON.stringify(post));
                        // Redirect to the post update page with the post ID
                        window.location.href = `/postupdate.html?id=${post._id}`;
                    });
                    menuContent.appendChild(updateOption);

                    const deleteOption = document.createElement('a');
                    deleteOption.href = '#';
                    deleteOption.textContent = 'Delete';
                    deleteOption.addEventListener('click', async () => {
                        try {
                            const confirmDelete = confirm('Are you sure you want to delete this post?');
                            if (confirmDelete) {
                                const token = localStorage.getItem('token');
                                const response = await fetch(`/api/profile/${post._id}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    }
                                });
                                if (!response.ok) {
                                    throw new Error('Failed to delete post');
                                }
                                alert('Post deleted successfully!');
                                fetchUserPosts(); // Refresh posts after deletion
                            }
                        } catch (error) {
                            console.error('Error deleting post:', error);
                            alert(`Error: ${error.message}`);
                        }
                    });
                    menuContent.appendChild(deleteOption);

                    menu.appendChild(menuContent);
                    const postOptions = document.createElement('div');
            postOptions.classList.add('post-options');
            postOptions.appendChild(menu);
            const commentSection = document.createElement('div');
                commentSection.id = `comment-section-${post._id}`;
                commentSection.style.display = 'none';

                const commentInput = document.createElement('input');
                commentInput.type = 'text';
                commentInput.placeholder = 'Add a comment...';

                const commentSubmitButton = document.createElement('button');
                commentSubmitButton.textContent = 'Submit';
                commentSubmitButton.addEventListener('click', async () => {
                    try {
                        const commentText = commentInput.value.trim();
                        if (!commentText) return;

                        const token = localStorage.getItem('token');
                        const userId = JSON.parse(localStorage.getItem('user')).userId;

                        if (!token) {
                            alert('User not authenticated');
                            return;
                        }

                        const response = await fetch(`/api/profile/${post._id}/comments`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ text: commentText })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to submit comment');
                        }

                        const newComment = await response.json();
                        const commentItem = document.createElement('p');
                        commentItem.textContent = newComment.text;
                        commentSection.appendChild(commentItem);
                        commentInput.value = '';
                    } catch (error) {
                        console.error('Error submitting comment:', error);
                    }
                });

                commentSection.appendChild(commentInput);
                commentSection.appendChild(commentSubmitButton);

                postElement.appendChild(menu);           
                postElement.appendChild(postOptions);
           
                    postElement.appendChild(title);
                    postElement.appendChild(description);
                    postElement.appendChild(uploadDate);
                    postElement.appendChild(mediaElement);
                    
                    postElement.appendChild(likeButton);
                    postElement.appendChild(commentButton);
                    postElement.appendChild(bookmarkButton);
                    postElement.appendChild(shareButton);
                    postElement.appendChild(commentSection);
                    //

                    profileFeed.appendChild(postElement);
                });
            }

            // Function to upload profile image
            function uploadProfileImage() {
                const profileImageInput = document.getElementById('profileImageInput');
                profileImageInput.click();

                profileImageInput.addEventListener('change', async () => {
                    const file = profileImageInput.files[0];
                    const formData = new FormData();
                    formData.append('profilePicture', file);

                    try {
                        const token = localStorage.getItem('token');
                        const userId = JSON.parse(localStorage.getItem('user')).userId;
                        const response = await fetch('/api/users/upload-profile-image', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });

                        if (!response.ok) {
                            throw new Error('Failed to upload profile picture');
                        }

                        const data = await response.json();
                        document.getElementById('profileImage').src = `/uploads/${data.filename}`;
                        document.getElementById('sidebarProfileImage').src = `/uploads/${data.filename}`;
                        alert('Profile picture updated successfully!');
                    } catch (error) {
                        console.error('Error uploading profile picture:', error);
                        alert(`Error: ${error.message}`);
                    }
                });
            }
            function toggleCommentSection(postId) {
            const commentSection = document.getElementById(`comment-section-${postId}`);
            commentSection.style.display = commentSection.style.display === 'none' ? 'block' : 'none';
        }
            fetchUserPosts(); // Fetch and display user's posts on page load
        });
        document.getElementById('logout').addEventListener('click', async function() {
    const token = localStorage.getItem('token');

    try {
        const response = await fetch('/api/logout', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('Failed to log out');
        }

        // Clear local storage and redirect to login page
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        alert("User logged out")
        window.location.href = 'login.html';
    } catch (error) {
        console.error('Error logging out:', error);
        alert('Error logging out');
    }
});

    </script>
</body>
</html>

